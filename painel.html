<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Disparador de Mensagens</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { padding: 20px; background-color: #f8f9fa; }
    .header-section { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 25px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .category-card { 
      cursor: pointer; 
      transition: all 0.3s; 
      border: 2px solid #dee2e6;
    }
    .category-card:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .category-card.active { 
      border: 2px solid #0d6efd; 
      background-color: #0d6efd; 
      color: #fff; 
    }
    #contactsInfo { text-align: center; margin-bottom: 20px; font-weight: 500; }
    #progBar { height: 20px; transition: width 0.3s; }
    .contact-form { background-color: #fff; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .contact-list { max-height: 400px; overflow-y: auto; margin-top: 15px; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; }
    .contact-item { border-bottom: 1px solid #e9ecef; padding: 10px 0; }
    .contact-item:last-child { border-bottom: none; }
    .evolution-status { font-size: 0.9rem; }
    .btn-stop { background-color: #dc3545; border-color: #dc3545; color: white; }
    .btn-stop:hover { background-color: #c82333; border-color: #bd2130; }
    .status-card { margin-bottom: 20px; }
    .alert { border: none; border-radius: 8px; }
    .btn-logout {
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
      transition: all 0.3s;
    }
    .btn-logout:hover {
      background: rgba(255,255,255,0.3);
      border-color: rgba(255,255,255,0.5);
      transform: translateY(-2px);
    }
    .user-info {
      background: rgba(255,255,255,0.1);
      padding: 10px 15px;
      border-radius: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div class="container">
  <!-- Header com Logout -->
  <div class="header-section">
    <div class="row align-items-center">
      <div class="col">
        <h1 class="mb-2">📱 Disparador de Mensagens WhatsApp</h1>
        <div class="user-info">
          <i class="fas fa-user"></i> <span id="currentUser">Carregando...</span> | 
          <i class="fas fa-plug"></i> <span id="userInstance">Carregando instância...</span>
        </div>
      </div>
      <div class="col-auto">
        <button id="btnLogout" class="btn btn-logout">
          <i class="fas fa-sign-out-alt"></i> Sair do Sistema
        </button>
      </div>
    </div>
  </div>

  <!-- Alerta de Segurança -->
  <div class="alert alert-info text-center">
    <strong>🔒 Modo Seguro Ativo</strong> - Delay aleatório de <strong>30 segundos a 60 segundos</strong> entre mensagens para evitar bloqueios
  </div>

  <!-- Status do Sistema -->
  <div class="card status-card">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">🔧 Status do Sistema</h5>
      <button onclick="verificarStatus()" class="btn btn-sm btn-outline-light">🔄 Atualizar</button>
    </div>
    <div class="card-body">
      <div id="evolutionStatus" class="evolution-status">
        <div class="text-muted">Verificando conexão com o Evolution API...</div>
      </div>
    </div>
  </div>

  <!-- Importar Contatos -->
  <div class="card status-card">
    <div class="card-header bg-success text-white">
      <h5 class="mb-0">📥 Importar Contatos</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h6>🔄 Do Arquivo CSV</h6>
              <p class="card-text">Importa automaticamente do arquivo <code>contatos.csv</code></p>
              <button onclick="atualizarDoCSV()" class="btn btn-success w-100">📁 Importar CSV</button>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card h-100">
            <div class="card-body">
              <h6>📤 Upload de Arquivo</h6>
              <p class="card-text">Faça upload de um arquivo CSV</p>
              <input type="file" id="csvFile" class="form-control mb-2" accept=".csv">
              <button onclick="importarCSVUpload()" class="btn btn-info w-100">📤 Fazer Upload</button>
            </div>
          </div>
        </div>
      </div>
      <div id="csvStatus" class="mt-3"></div>
    </div>
  </div>

  <!-- Gerenciar Contatos -->
  <div class="contact-form">
    <h3>👥 Gerenciar Contatos</h3>
    <div class="row g-3 mb-3">
      <div class="col-md-4">
        <input type="text" id="newName" class="form-control" placeholder="Nome completo">
      </div>
      <div class="col-md-3">
        <input type="text" id="newNumber" class="form-control" placeholder="Número (DDD + número)">
      </div>
      <div class="col-md-3">
        <select id="newCategory" class="form-select">
          <option value="sider">🚛 Sider</option>
          <option value="grade_alta">📦 Grade Alta</option>
          <option value="grade_baixa">📦 Grade Baixa</option>
          <option value="bitrem">🚚 Bitrem</option>
          <option value="rodotrem">🚛 Rodotrem</option>
          <option value="prancha">🛻 Prancha</option>
          <option value="bau">📦 Baú</option>
          <option value="SIDER _ GRADE BAIXA">🛻 SIDER _ GRADE BAIXA</option>
          <option value="GRADE BAIXA _GRANELEIRO">🛻 GRADE BAIXA _GRANELEIRO</option>
          <option value="TRUCK _ GRANELEIRA">🚚 TRUCK _ GRANELEIRA</option>
          <option value="GRANELEIRO">🚚 GRANELEIRO</option>
        </select>
      </div>
      <div class="col-md-2">
        <button id="addContact" class="btn btn-success w-100">➕ Adicionar</button>
      </div>
    </div>
    
    <div class="contact-list" id="contactsList">
      <div class="text-center text-muted py-4">
        <div>📋 Selecione uma categoria para ver os contatos</div>
        <small>Os contatos aparecerão aqui após selecionar uma categoria</small>
      </div>
    </div>
  </div>

  <!-- Teste Rápido -->
  <div class="card status-card">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0">🧪 Teste Rápido</h5>
    </div>
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label fw-bold">Número para teste</label>
          <input type="text" id="testNumber" class="form-control" placeholder="5511999999999" value="5511999999999">
        </div>
        <div class="col-md-5">
          <label class="form-label fw-bold">Mensagem de teste</label>
          <input type="text" id="testMessage" class="form-control" value="✅ Teste do sistema de disparo">
        </div>
        <div class="col-md-3">
          <button onclick="testarEnvio()" class="btn btn-warning w-100 fw-bold">📤 Enviar Teste</button>
        </div>
      </div>
      <div id="testResult" class="mt-3"></div>
    </div>
  </div>

  <!-- Categorias -->
  <div class="card status-card">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">📂 Categorias de Contatos</h5>
    </div>
    <div class="card-body">
      <div class="row g-3" id="categories">
        <div class="col-6 col-md-4 col-lg-3">
          <div class="card category-card text-center p-3" data-cat="sider">
            <div class="fw-bold">🚛 Sider</div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="card category-card text-center p-3" data-cat="grade_alta">
            <div class="fw-bold">📦 Grade Alta</div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="card category-card text-center p-3" data-cat="grade_baixa">
            <div class="fw-bold">📦 Grade Baixa</div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="card category-card text-center p-3" data-cat="bitrem">
            <div class="fw-bold">🚚 Bitrem</div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="card category-card text-center p-3" data-cat="rodotrem">
            <div class="fw-bold">🚛 Rodotrem</div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="card category-card text-center p-3" data-cat="prancha">
            <div class="fw-bold">🛻 Prancha</div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="card category-card text-center p-3" data-cat="bau">
            <div class="fw-bold">📦 Baú</div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="card category-card text-center p-3" data-cat="SIDER _ GRADE BAIXA">
            <div class="fw-bold">🛻 SIDER _ GRADE BAIXA</div>
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="card category-card text-center p-3" data-cat="GRADE BAIXA _GRANELEIRO">
            <div class="fw-bold">🛻 GRADE BAIXA _GRANELEIRO</div>
           </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="card category-card text-center p-3" data-cat="TRUCK _ GRANELEIRA">
            <div class="fw-bold">🚚 TRUCK _ GRANELEIRA</div>     
          </div>
        </div>
        <div class="col-6 col-md-4 col-lg-3">
          <div class="card category-card text-center p-3" data-cat="GRANELEIRO">
            <div class="fw-bold">🚚 GRANELEIRO</div>     
            </div>
        </div>    
      </div>
    </div>
  </div>

  <!-- Informações dos Contatos -->
  <div class="alert alert-info text-center" id="contactsInfo">
    👆 Selecione uma categoria acima para carregar os contatos
  </div>

  <!-- Mensagem e Envio -->
  <div class="card status-card">
    <div class="card-header bg-danger text-white">
      <h5 class="mb-0">🚀 Disparo em Massa</h5>
    </div>
    <div class="card-body">
      <div class="mb-3">
        <label for="msg" class="form-label fw-bold">💬 Mensagem Personalizada:</label>
        <textarea id="msg" class="form-control" rows="4" placeholder="Digite sua mensagem aqui...">Olá {{name}}, temos uma viagem disponível para você na categoria {{category}}.</textarea>
        <small class="text-muted">
          🔧 Variáveis disponíveis: <code>{{name}}</code>, <code>{{number}}</code>, <code>{{category}}</code>
        </small>
      </div>

      <!-- Botões de Envio e Parada -->
      <div class="row g-2 mb-3">
        <div class="col-md-9">
          <button id="sendBtn" class="btn btn-danger w-100 fw-bold py-2">🚀 INICIAR DISPARO EM MASSA</button>
        </div>
        <div class="col-md-3">
          <button id="stopBtn" class="btn btn-stop w-100 fw-bold py-2" style="display: none;">🛑 PARAR ENVIO</button>
        </div>
      </div>

      <!-- Barra de Progresso -->
      <div class="progress mb-2" style="height: 25px;">
        <div id="progBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">
          <span class="fw-bold" id="progressText">0%</span>
        </div>
      </div>
      
      <!-- Status Detalhado -->
      <div id="status" class="text-center fw-semibold alert alert-light">
        Pronto para iniciar o disparo
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ========== CONFIGURAÇÕES GLOBAIS ==========
const SERVER_URL = window.location.origin;
let envioAtivo = false;
let selectedCat = null;
let contacts = [];

// ========== INICIALIZAÇÃO ==========
document.addEventListener('DOMContentLoaded', function() {
  verificarStatus();
  carregarEventos();
  carregarInformacoesUsuario();
});

// ========== FUNÇÕES DE USUÁRIO E LOGOUT ==========
async function carregarInformacoesUsuario() {
  try {
    console.log('🔐 Verificando autenticação...');
    
    const response = await fetch(`${SERVER_URL}/api/auth/status`, {
      credentials: 'include'
    });
    
    console.log('📡 Status HTTP:', response.status);
    
    if (response.ok) {
      const data = await response.json();
      console.log('📊 Dados do usuário:', data);
      
      if (data.autenticado && data.usuario) {
        console.log('✅ USUÁRIO AUTENTICADO:', data.usuario);
        document.getElementById('currentUser').textContent = data.usuario;
        
        // ✅ MAPEAMENTO COMPLETO DE INSTÂNCIAS
        const userInstances = {
          'admin': 'TESTE',
          'JBO': 'JBO',
          'CABO': 'CABO',
          'BA': 'BA',
          'PB': 'PB',
          'SP': 'SP', 
          'AL': 'AL',
          'AMBEV': 'AMBEV',
          'USINA': 'USINA',
          'DISP3': 'DISP3'
        };
        
        // Usar a instância da configuração ou fallback para o mapeamento
        const userInstance = data.config?.instanceName || userInstances[data.usuario] || 'Não configurada';
        document.getElementById('userInstance').textContent = userInstance;
        
        console.log('🏷️ Instância do usuário:', userInstance);
        
      } else {
        console.log('❌ USUÁRIO NÃO AUTENTICADO - Redirecionando...');
        window.location.href = '/';
      }
    } else {
      console.log('❌ ERRO HTTP - Redirecionando...');
      window.location.href = '/';
    }
  } catch (error) {
    console.error('❌ ERRO DE CONEXÃO:', error);
    window.location.href = '/';
  }
}

// ✅ DEBUG SEGURO (OPCIONAL - pode remover completamente se quiser)
async function debugAuthSafe() {
  console.log('=== 🔍 DEBUG SEGURO ===');
  
  try {
    // Apenas verifica status atual SEM fazer login
    const statusRes = await fetch('/api/auth/status', {
      credentials: 'include'
    });
    
    const statusData = await statusRes.json();
    console.log('🔐 Status de autenticação:', statusData);
    
    // Testa conexão com Evolution
    const evolutionRes = await fetch('/webhook/status-evolution', {
      credentials: 'include'
    });
    
    const evolutionData = await evolutionRes.json();
    console.log('📡 Status Evolution:', evolutionData);
    
  } catch (error) {
    console.error('❌ Erro no debug:', error);
  }
}

// NÃO execute automaticamente - apenas para uso manual no console
// debugAuthSafe() // ← DEIXE COMENTADO!

// ✅ FUNÇÃO DE LOGOUT
async function fazerLogout() {
  if (confirm('Deseja realmente sair do sistema?')) {
    try {
      console.log('🚪 Fazendo logout...');
      
      const response = await fetch(`${SERVER_URL}/api/logout`, {
        method: 'POST',
        credentials: 'include'
      });
      
      if (response.ok) {
        console.log('✅ Logout bem-sucedido');
      }
    } catch (error) {
      console.error('❌ Erro no logout:', error);
    } finally {
      // Redireciona para login independente do resultado
      window.location.href = '/';
    }
  }
}

// ========== STATUS DO SISTEMA ==========
async function verificarStatus() {
  const statusDiv = document.getElementById('evolutionStatus');
  statusDiv.innerHTML = '<div class="text-info">🔍 Verificando conexão com Evolution API...</div>';
  
  try {
    const res = await fetch(`${SERVER_URL}/webhook/status-evolution`);
    const data = await res.json();
    
    if (data.connected) {
      statusDiv.innerHTML = `
        <div class="alert alert-success">
          <strong>✅ ${data.message}</strong>
          <div class="row mt-2">
            <div class="col-6">
              <small>Versão: <strong>${data.version || 'N/A'}</strong></small>
            </div>
            <div class="col-6">
              <small>Instância: <strong>${data.instance || 'N/A'}</strong></small>
            </div>
          </div>
        </div>
      `;
    } else {
      statusDiv.innerHTML = `
        <div class="alert alert-danger">
          <strong>❌ ${data.error || 'Erro de conexão'}</strong>
          <div class="small">${data.message || ''}</div>
        </div>
      `;
    }
  } catch (err) {
    statusDiv.innerHTML = `
      <div class="alert alert-danger">
        <strong>❌ Servidor não responde</strong>
        <div class="small">Verifique se o servidor está rodando na porta 5680</div>
      </div>
    `;
  }
}

// ========== IMPORTAR CONTATOS ==========
async function atualizarDoCSV() {
  const statusDiv = document.getElementById('csvStatus');
  statusDiv.innerHTML = `
    <div class="alert alert-info">
      <strong>📤 Importando do contatos.csv...</strong>
      <div class="progress mt-2">
        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
      </div>
    </div>
  `;
  
  try {
    const response = await fetch(`${SERVER_URL}/webhook/importar-csv`);
    const result = await response.json();
    
    if (result.success) {
      statusDiv.innerHTML = `
        <div class="alert alert-success">
          <strong>✅ CSV Importado com Sucesso!</strong><br>
          📊 Total processado: ${result.total} contatos<br>
          ✅ Novos inseridos: ${result.inseridos}<br>
          ⚠️ Duplicados ignorados: ${result.erros}
        </div>
      `;
      
      // Recarregar categoria atual
      if (selectedCat) {
        setTimeout(() => carregarContatos(selectedCat), 1000);
      }
      
    } else {
      statusDiv.innerHTML = `<div class="alert alert-danger">❌ ${result.error}</div>`;
    }
    
  } catch (err) {
    statusDiv.innerHTML = '<div class="alert alert-danger">❌ Erro de conexão com o servidor</div>';
  }
}

async function importarCSVUpload() {
  const fileInput = document.getElementById('csvFile');
  const file = fileInput.files[0];
  const statusDiv = document.getElementById('csvStatus');
  
  if (!file) {
    statusDiv.innerHTML = '<div class="alert alert-warning">⚠️ Selecione um arquivo CSV</div>';
    return;
  }
  
  statusDiv.innerHTML = '<div class="alert alert-info">📤 Processando arquivo...</div>';
  
  try {
    const text = await file.text();
    const contatos = [];
    const lines = text.split('\n');
    
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue;
      
      const parts = line.split(',');
      if (parts.length >= 2) {
        const name = parts[0].trim();
        const number = parts[1].trim();
        const category = parts[2] ? parts[2].trim() : 'sider';
        
        if (name && number) {
          contatos.push({ name, number, category });
        }
      }
    }
    
    if (contatos.length === 0) {
      statusDiv.innerHTML = '<div class="alert alert-warning">⚠️ Nenhum contato válido encontrado</div>';
      return;
    }
    
    // Enviar para o servidor
    const response = await fetch(`${SERVER_URL}/webhook/contatos/lote`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ contatos })
    });
    
    const result = await response.json();
    
    if (response.ok) {
      statusDiv.innerHTML = `
        <div class="alert alert-success">
          <strong>✅ Upload Concluído!</strong><br>
          📊 Total: ${result.total} contatos<br>
          ✅ Inseridos: ${result.inseridos} novos<br>
          ⚠️ Duplicados: ${result.erros} ignorados
        </div>
      `;
      
      fileInput.value = '';
      
      // Recarregar contatos
      if (selectedCat) {
        setTimeout(() => carregarContatos(selectedCat), 1000);
      }
      
    } else {
      statusDiv.innerHTML = `<div class="alert alert-danger">❌ Erro: ${result.error}</div>`;
    }
    
  } catch (err) {
    statusDiv.innerHTML = '<div class="alert alert-danger">❌ Erro ao processar arquivo</div>';
  }
}

// ========== TESTE RÁPIDO ==========
async function testarEnvio() {
  const testNumber = document.getElementById('testNumber').value.trim();
  const testMessage = document.getElementById('testMessage').value.trim();
  const resultDiv = document.getElementById('testResult');
  
  if (!testNumber) {
    resultDiv.innerHTML = '<div class="alert alert-warning">⚠️ Digite um número para teste</div>';
    return;
  }
  
  resultDiv.innerHTML = '<div class="alert alert-info">📤 Enviando mensagem de teste...</div>';
  
  try {
    const response = await fetch(`${SERVER_URL}/webhook/send`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        number: testNumber,
        message: testMessage,
        category: 'teste',
        meta: { name: 'Teste' }
      })
    });
    
    const result = await response.json();
    
    if (result.success) {
      resultDiv.innerHTML = '<div class="alert alert-success">✅ Mensagem enviada com sucesso!</div>';
    } else {
      resultDiv.innerHTML = `<div class="alert alert-danger">❌ ${result.error}</div>`;
    }
  } catch (err) {
    resultDiv.innerHTML = '<div class="alert alert-danger">❌ Erro de conexão com o servidor</div>';
  }
}

// ========== CARREGAR EVENTOS ==========
function carregarEventos() {
  // Categorias
  document.querySelectorAll('.category-card').forEach(card => {
    card.addEventListener('click', () => {
      const categoria = card.dataset.cat;
      carregarContatos(categoria);
    });
  });

  // Adicionar contato
  document.getElementById('addContact').addEventListener('click', adicionarContato);

  // Botão de parar
  document.getElementById('stopBtn').addEventListener('click', pararEnvio);

  // ✅ Botão de logout
  document.getElementById('btnLogout').addEventListener('click', fazerLogout);
}

// ========== FUNÇÕES PRINCIPAIS ==========
async function carregarContatos(categoria) {
  // Ativar categoria
  document.querySelectorAll('.category-card').forEach(c => c.classList.remove('active'));
  document.querySelector(`[data-cat="${categoria}"]`).classList.add('active');
  
  selectedCat = categoria;
  const contactsInfo = document.getElementById('contactsInfo');
  const contactsList = document.getElementById('contactsList');
  
  contactsInfo.innerHTML = `<div class="text-info">📋 Carregando contatos para ${categoria}...</div>`;
  contactsList.innerHTML = '<div class="text-center py-3">⏳ Carregando...</div>';

  try {
    const url = `${SERVER_URL}/webhook/contatos?categoria=${categoria}`;
    const res = await fetch(url);
    
    if (!res.ok) throw new Error('Erro ao carregar contatos');
    
    contacts = await res.json();
    contactsInfo.innerHTML = `
      <div class="alert alert-success">
        <strong>📊 ${contacts.length} contatos encontrados</strong>
        <div class="small">Categoria: ${categoria}</div>
      </div>
    `;
    
    atualizarListaContatos();
  } catch (err) {
    console.error('❌ Erro ao carregar contatos:', err);
    contactsInfo.innerHTML = '<div class="alert alert-danger">❌ Erro ao carregar contatos</div>';
    contactsList.innerHTML = '<div class="text-center text-danger py-3">❌ Erro ao carregar contatos</div>';
  }
}

function atualizarListaContatos() {
  const contactsList = document.getElementById('contactsList');
  
  if (contacts.length === 0) {
    contactsList.innerHTML = '<div class="text-center text-muted py-4">📭 Nenhum contato encontrado</div>';
    return;
  }
  
  let html = '';
  contacts.forEach(contact => {
    html += `
      <div class="contact-item">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>${contact.name}</strong><br>
            <small class="text-muted">${contact.number}</small>
          </div>
          <span class="badge bg-secondary">${contact.category}</span>
        </div>
      </div>
    `;
  });
  contactsList.innerHTML = html;
}

async function adicionarContato() {
  const name = document.getElementById('newName').value.trim();
  const number = document.getElementById('newNumber').value.trim();
  const category = document.getElementById('newCategory').value;
  
  if (!name || !number) {
    alert('⚠️ Preencha nome e número');
    return;
  }
  
  try {
    const res = await fetch(`${SERVER_URL}/webhook/contatos`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, number, category })
    });
    
    if (res.ok) {
      alert(`✅ Contato "${name}" adicionado com sucesso!`);
      document.getElementById('newName').value = '';
      document.getElementById('newNumber').value = '';
      
      // Recarregar contatos se a categoria for a mesma
      if (selectedCat === category) {
        carregarContatos(category);
      }
    } else {
      alert('❌ Erro ao adicionar contato');
    }
  } catch (err) {
    console.error('❌ Erro de conexão:', err);
    alert('❌ Erro de conexão com o servidor');
  }
}

function renderMessage(template, contact) {
  return template
    .replace(/{{\s*name\s*}}/gi, contact.name || '')
    .replace(/{{\s*number\s*}}/gi, contact.number || '')
    .replace(/{{\s*category\s*}}/gi, contact.category || '');
}

// ========== DISPARO EM MASSA COM DELAY ALEATÓRIO ==========
async function iniciarDisparo() {
  if (!selectedCat) {
    alert('⚠️ Selecione uma categoria primeiro');
    return;
  }
  
  if (!contacts.length) {
    alert('⚠️ Nenhum contato carregado para disparo');
    return;
  }

  const template = document.getElementById('msg').value;
  if (!template.trim()) {
    alert('⚠️ Digite uma mensagem para enviar');
    return;
  }

  // Calcular tempo estimado (30-120 segundos por mensagem)
  const tempoMin = Math.ceil((contacts.length * 30) / 60);
  const tempoMax = Math.ceil((contacts.length * 120) / 60);
  
  if (!confirm(`🚀 Iniciar disparo para ${contacts.length} contatos?\n\n⏰ Tempo estimado: ${tempoMin} a ${tempoMax} minutos\n🔒 Delay de segurança: 30s a 2min entre mensagens`)) {
    return;
  }

  // Configurar interface para envio
  envioAtivo = true;
  const sendBtn = document.getElementById('sendBtn');
  const stopBtn = document.getElementById('stopBtn');
  const progBar = document.getElementById('progBar');
  const progressText = document.getElementById('progressText');
  const statusDiv = document.getElementById('status');
  
  sendBtn.disabled = true;
  sendBtn.textContent = '⏳ Enviando...';
  stopBtn.style.display = 'block';
  progBar.style.width = '0%';
  progressText.textContent = '0%';
  
  let completed = 0;
  let successCount = 0;
  let errorCount = 0;

  // Enviar mensagens COM DELAY ALEATÓRIO
  for (const contact of contacts) {
    if (!envioAtivo) break;
    
    const message = renderMessage(template, contact);
    
    try {
      const res = await fetch(`${SERVER_URL}/webhook/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          number: contact.number, 
          message: message, 
          category: selectedCat, 
          meta: { name: contact.name } 
        })
      });
      
      const result = await res.json();
      
      if (result.success) {
        successCount++;
        console.log(`✅ Enviado para: ${contact.name}`);
      } else {
        errorCount++;
        console.error(`❌ Erro para ${contact.name}:`, result.error);
      }
    } catch (err) {
      errorCount++;
      console.error(`❌ Erro de conexão para ${contact.name}:`, err);
    }
    
    // Atualizar progresso
    completed++;
    const progress = Math.round((completed / contacts.length) * 100);
    progBar.style.width = progress + '%';
    progressText.textContent = `${progress}%`;
    
    // Aplicar delay aleatório entre mensagens (30s a 60s) - exceto na última
    if (envioAtivo && completed < contacts.length) {
      const delaySeconds = Math.floor(Math.random() * (60 - 30 + 1)) + 30;
      
      statusDiv.innerHTML = `
        <div class="text-center">
          <strong>📤 Enviando: ${completed} / ${contacts.length}</strong><br>
          <small>✅ Sucessos: ${successCount} | ❌ Erros: ${errorCount}</small>
          <div class="mt-1">
            <small class="text-warning">⏰ Próxima mensagem em ${delaySeconds} segundos...</small>
          </div>
        </div>
      `;
      
      console.log(`⏰ Aguardando ${delaySeconds} segundos para próxima mensagem...`);
      
      // Aguardar o delay
      await new Promise(resolve => setTimeout(resolve, delaySeconds * 1000));
    } else {
      statusDiv.innerHTML = `
        <div class="text-center">
          <strong>📤 Enviando: ${completed} / ${contacts.length}</strong><br>
          <small>✅ Sucessos: ${successCount} | ❌ Erros: ${errorCount}</small>
        </div>
      `;
    }
  }

  // Finalizar
  finalizarEnvio(successCount, errorCount);
}

function pararEnvio() {
  envioAtivo = false;
  const stopBtn = document.getElementById('stopBtn');
  const statusDiv = document.getElementById('status');
  
  stopBtn.style.display = 'none';
  statusDiv.innerHTML = '<div class="alert alert-warning">🛑 Envio interrompido pelo usuário</div>';
}

function finalizarEnvio(successCount, errorCount) {
  envioAtivo = false;
  const sendBtn = document.getElementById('sendBtn');
  const stopBtn = document.getElementById('stopBtn');
  const progBar = document.getElementById('progBar');
  const progressText = document.getElementById('progressText');
  const statusDiv = document.getElementById('status');
  
  // ✅ RESETAR TODA A INTERFACE
  sendBtn.disabled = false;
  sendBtn.textContent = '🚀 INICIAR DISPARO EM MASSA';
  stopBtn.style.display = 'none';
  progBar.style.width = '100%';
  progBar.classList.remove('progress-bar-animated');
  progressText.textContent = '100%';
  
  let message = `✅ Disparo concluído!\n\n`;
  message += `📊 Total de contatos: ${contacts.length}\n`;
  message += `✅ Mensagens enviadas: ${successCount}\n`;
  
  if (errorCount > 0) {
    message += `❌ Erros: ${errorCount}`;
  }
  
  alert(message);
  
  statusDiv.innerHTML = `
    <div class="alert alert-success">
      <strong>✅ Disparo Concluído!</strong><br>
      📊 Total: ${contacts.length} contatos<br>
      ✅ Sucessos: ${successCount} mensagens<br>
      ${errorCount > 0 ? `❌ Erros: ${errorCount} mensagens` : '🎉 Todos os envios foram bem-sucedidos!'}
    </div>
  `;
  
  console.log('✅ Interface resetada após envio');
}

// Configurar botão de envio
document.getElementById('sendBtn').addEventListener('click', iniciarDisparo);

console.log('✅ Sistema carregado com sucesso!');
console.log('🔒 Modo seguro ativo: Delay aleatório de 30s a 60s entre mensagens');
</script>
</body>
</html>